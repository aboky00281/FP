<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>คำนวณขนาดปั๊มดับเพลิงและถังเก็บน้ำ (NFPA) By วัยรุ่นเซินเจิ้น</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base styles for body and container */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            border: 1px solid #e2e8f0;
        }
        /* Form group and input styling */
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #334155;
        }
        input[type="number"],
        input[type="text"], /* Added style for text input */
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
            color: #475569;
            box-sizing: border-box;
        }
        input[type="number"]:focus,
        input[type="text"]:focus, /* Added style for text input focus */
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        /* Button styling */
        .btn-primary {
            width: 100%;
            padding: 12px 20px;
            background-color: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #16a34a;
            transform: translateY(-2px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-secondary {
            width: 100%;
            padding: 12px 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        .btn-secondary:active {
            transform: translateY(0);
        }
        /* New Clear Data Button Style */
        .btn-clear {
            width: 100%;
            padding: 12px 20px;
            background-color: #ef4444; /* Red color */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 10px; /* Space between calculate and clear */
        }
        .btn-clear:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .btn-clear:active {
            transform: translateY(0);
        }

        /* Results section styling */
        .results-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8fafc;
            border: 1px dashed #94a3b8;
            border-radius: 8px;
        }
        .results-section h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
            text-align: center;
        }
        .results-section p {
            font-size: 16px;
            color: #475569;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .results-section p strong {
            color: #1e293b;
        }
        /* Warning and disclaimer styling */
        .warning {
            color: #dc2626;
            background-color: #fef2f2;
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ef4444;
            font-weight: 500;
        }
        .disclaimer {
            font-size: 14px;
            color: #64748b;
            margin-top: 20px;
            text-align: center;
            line-height: 1.4;
        }
        .small-text {
            font-size: 13px;
            color: #64748b;
            margin-top: 5px;
            display: block;
        }
        /* Chart specific styling */
        #pumpCurveChart {
            margin-top: 20px;
            max-height: 400px; /* Increased chart height for better visibility */
        }
        .chart-disclaimer {
            font-size: 12px;
            color: #64748b;
            text-align: center;
            margin-top: 10px;
        }
        .toggle-button {
            background-color: #60a5fa; /* Blue-ish button */
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
            margin-left: 10px;
            display: inline-block; /* Align with text */
            vertical-align: middle; /* Align with text */
        }
        .toggle-button:hover {
            background-color: #3b82f6;
        }

        /* Print specific styles */
        @media print {
            body {
                background-color: #fff;
                -webkit-print-color-adjust: exact; /* For better color printing on some browsers */
                print-color-adjust: exact;
                display: block; /* Override flex for printing */
                min-height: auto; /* Allow content to flow */
                height: auto; /* Allow content to flow */
            }
            .container {
                box-shadow: none;
                border: none;
                max-width: none; /* Allow full width */
                width: auto; /* Allow auto width */
                padding: 0; /* Remove padding */
                margin: 0; /* Remove margin */
            }
            /* Hide buttons and disclaimer on print */
            button, .disclaimer, .print-pdf-buttons, .toggle-button, .btn-clear { /* Added .btn-clear */
                display: none !important;
            }
            /* Ensure form groups are explicitly visible */
            .form-group {
                display: block !important;
                margin-bottom: 10px !important; /* Adjust margin for print */
            }
            label, input[type="number"], input[type="text"], select, .small-text {
                display: block !important;
                width: auto !important; /* Prevent fixed width issues */
                padding: 5px !important; /* Smaller padding for print */
                border: 1px solid #ccc !important; /* Visible border */
                border-radius: 0 !important; /* No rounded corners on print */
                box-shadow: none !important; /* No shadow on print */
                font-size: 12px !important; /* Smaller font size for print */
                color: #000 !important; /* Black text for print */
            }

            /* Ensure results section is visible and well formatted on its own page (Page 2) */
            #results_page {
                page-break-before: always;
                margin-top: 0 !important;
                padding-top: 0 !important;
                width: 100%;
            }
            /* Ensure pump info and chart section is visible and well formatted on its own page (Page 3) */
            #pump_info_and_chart_section {
                page-break-before: always;
                margin-top: 0 !important;
                padding-top: 0 !important;
                width: 100%;
            }
            .results-section {
                border: none; /* Remove border for print */
                background-color: #fff; /* White background */
                padding: 0; /* No padding */
            }

            /* Show calculation explanations on print */
            #sprinkler_flow_calculation, #tank_volume_calculation, #demand_head_calculation { /* Added demand_head_calculation */
                display: block !important;
                margin-top: 5px !important; /* Smaller margin for print */
                font-size: 12px !important; /* Smaller font size for print */
                color: #000 !important; /* Black text for print */
                line-height: 1.2 !important; /* Tighter line height for print */
            }
            .chart-disclaimer {
                display: block !important;
                font-size: 10px !important; /* Even smaller font for disclaimer */
                color: #333 !important;
            }
            #demand_head_display_container {
                display: block !important;
                font-weight: bold;
            }
            #demand_head_display_container span {
                color: #dc2626 !important;
            }
            /* General print adjustments for other elements */
            h1, h2, h3 {
                color: #000 !important;
                text-align: left !important; /* Left align headings for print readability */
                margin-bottom: 10px !important;
                font-size: 20px !important; /* Adjust heading size */
            }
            .results-section h2 {
                 text-align: left !important;
                 font-size: 18px !important;
            }
            .results-section p {
                font-size: 14px !important;
                color: #000 !important;
                margin-bottom: 5px !important;
            }
            .results-section p strong {
                color: #000 !important;
            }
            #area_name_display {
                display: block !important;
                margin-bottom: 10px;
                font-size: 14px !important;
                color: #000 !important;
            }
            #area_name_display strong {
                color: #000 !important;
            }

            /* Chart specific adjustments for print */
            #pumpCurveChart {
                margin-top: 15px !important;
                max-height: 400px !important; /* Give more height for better chart rendering */
                width: 100% !important;
            }

            /* Graph Summary Section for Print */
            #graph_summary {
                display: block !important; /* Ensure it's always displayed on print */
                margin-top: 15px !important;
                font-size: 12px !important; /* Adjust font size for print */
                color: #000 !important; /* Black text for print */
            }
            #graph_summary h4 {
                font-size: 16px !important; /* Smaller heading for summary */
                margin-bottom: 5px !important;
                text-align: left !important;
            }
            #graph_summary ul {
                list-style-type: disc;
                margin-left: 20px !important;
            }
            #graph_summary li {
                margin-bottom: 3px !important;
                line-height: 1.3 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            คำนวณขนาดปั๊มดับเพลิงและถังเก็บน้ำ (NFPA Guidance) By วัยรุ่นเซินเจิ้น
        </h1>
        <p class="disclaimer mb-6">
            เครื่องมือนี้ใช้สำหรับการประมาณการเบื้องต้นเท่านั้น ไม่สามารถใช้ทดแทนการออกแบบโดยวิศวกรผู้เชี่ยวชาญได้
            การออกแบบระบบจริงต้องพิจารณาปัจจัยทางวิศวกรรมที่ซับซับซ้อนอื่นๆ เสมอ โปรดปรึกษาวิศวกรที่มีใบอนุญาตสำหรับการออกแบบระบบจริง
        </p>

        <div class="form-group" id="area_name_group">
            <label for="area_name">ชื่อ/รายละเอียดพื้นที่:</label>
            <input type="text" id="area_name" placeholder="เช่น อาคารสำนักงาน A ชั้น 3" class="rounded-lg shadow-sm">
        </div>

        <div class="form-group" id="hazard_class_group">
            <label for="hazard_class">เลือกประเภทอันตราย (Occupancy Hazard Classification):</label>
            <select id="hazard_class" class="rounded-lg shadow-sm">
                <option value="light">Light Hazard (อันตรายน้อย)</option>
                <option value="ordinary1">Ordinary Hazard Group 1 (อันตรายปานกลาง กลุ่ม 1)</option>
                <option value="ordinary2">Ordinary Hazard Group 2 (อันตรายปานกลาง กลุ่ม 2)</option>
                <option value="extra1">Extra Hazard Group 1 (อันตรายมาก กลุ่ม 1)</option>
                <option value="extra2">Extra Hazard Group 2 (อันตรายมาก กลุ่ม 2)</option>
            </select>
        </div>

        <div class="form-group" id="design_area_group">
            <label for="design_area">พื้นที่ป้องกัน (Design Area - ตร.ม.):</label>
            <input type="number" id="design_area" placeholder="เช่น 139.4 ตร.ม." min="0.1" step="0.1" class="rounded-lg shadow-sm">
            <small class="small-text">
                อ้างอิง NFPA 13: Light/Ordinary Hazard อย่างน้อย 139.4 ตร.ม. (ประมาณ 1500 ตร.ฟุต) สำหรับสปริงเกลอร์มาตรฐาน
            </small>
        </div>

        <div class="form-group" id="duration_group">
            <label for="duration">ระยะเวลาการจ่ายน้ำขั้นต่ำ (นาที):</label>
            <select id="duration" class="rounded-lg shadow-sm">
                <option value="30">30 นาที (สำหรับ Light Hazard)</option>
                <option value="60">60 นาที (สำหรับ Ordinary Hazard Group 1)</option>
                <option value="90">90 นาที (สำหรับ Ordinary Hazard Group 2, Extra Hazard Group 1)</option>
                <option value="120">120 นาที (สำหรับ Extra Hazard Group 2)</option>
            </select>
            <small class="small-text">อ้างอิง NFPA 13 Table 11.2.1.2</small>
        </div>

        <div class="flex flex-col gap-y-4">
            <button onclick="calculate()" class="btn-primary rounded-lg shadow-md">คำนวณ</button>
            <button onclick="clearData()" class="btn-clear rounded-lg shadow-md">ล้างข้อมูล</button>
        </div>

        <div id="results_page" class="pt-8">
            <div id="results" class="results-section">
                <h2>ผลการคำนวณ:</h2>
                <p id="area_name_display" style="display:none;">
                    <strong>สำหรับพื้นที่:</strong> <span id="display_area_name"></span>
                </p>
                <p>
                    <strong>อัตราการไหลของน้ำดับเพลิง (สปริงเกลอร์):</strong> <span id="sprinkler_flow" class="font-bold">0.00</span> GPM
                    <button onclick="toggleSprinklerCalculation()" class="toggle-button">ดูวิธีการคำนวsณ</button>
                </p>
                <p id="sprinkler_flow_calculation" class="hidden small-text"></p>
                <p><strong>อัตราการไหลสำหรับท่อยืน (Hose Stream Allowance):</strong> <span id="hose_allowance">0.00</span> GPM</p>
                <p>
                    <strong>อัตราการไหลรวมที่ต้องการ (ขนาดปั๊มดับเพลิง):</strong> <span id="total_flow" class="font-bold text-red-600">0.00</span> GPM
                </p>
                <p id="demand_head_display_container" class="hidden">
                    <strong>แรงดันที่จุดต้องการ:</strong> <span id="demand_head_display" class="text-red-600 font-bold">0.00</span> PSI
                    <button onclick="toggleDemandHeadCalculation()" class="toggle-button">ดูวิธีการคำนวณ</button>
                </p>
                <p id="demand_head_calculation" class="hidden small-text"></p> <p>
                    <strong>ขนาดถังเก็บน้ำที่ต้องการ:</strong> <span id="tank_volume">0.00</span> ลบ.ม.
                    <button onclick="toggleTankVolumeCalculation()" class="toggle-button">ดูวิธีการคำนวณ</button>
                </p>
                <p id="tank_volume_calculation" class="hidden small-text"></p>
                <p><strong>เวลากักเก็บน้ำที่คำนวณ:</strong> <span id="actual_duration">0</span> นาที</p>
                <div class="warning hidden" id="warning_message"></div>
            </div>
        </div>

        <div id="pump_info_and_chart_section" class="pt-8">
            <h3 class="text-xl font-bold text-center text-gray-700 mt-8 mb-4">
                กราฟ Flow Rate vs. Head (Performance Curve จำลอง)
            </h3>
            <div class="form-group">
                <label for="pump_rated_flow">อัตราการไหลกำหนดของปั๊ม (GPM):</label>
                <input type="number" id="pump_rated_flow" placeholder="เช่น 750 GPM" min="0" step="10" class="rounded-lg shadow-sm">
                <small class="small-text">อัตราการไหล ณ จุดทำงานที่ระบุโดยผู้ผลิต (Rated Flow)</small>
            </div>
            <div class="form-group">
                <label for="system_demand_head">แรงดันต้องการของระบบ (PSI):</label>
                <input type="number" id="system_demand_head" placeholder="เช่น 70 PSI" min="0" step="1" class="rounded-lg shadow-sm">
                <small class="small-text">ค่าแรงดันที่คุณต้องการดูจุดตัดบนกราฟ Performance Curve</small>
            </div>
            <button onclick="calculate()" class="btn-primary rounded-lg shadow-md mb-4">คำนวณ (สำหรับกราฟ)</button>


            <canvas id="pumpCurveChart"></canvas>

            <div id="graph_summary" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 class="text-lg font-semibold text-blue-800 mb-3">คำอธิบายกราฟ:</h4>
                <ul class="list-disc ml-5 text-gray-700 text-sm">
                    <li><strong>พื้นที่ปฏิบัติงานที่แนะนำ (สีเขียว):</strong> พื้นที่โปร่งแสงใต้เส้น Performance Curve (65% Max. churn ถึง 150% Rated Flow)</li>
                    <li><strong>Performance Curve จำลอง:</strong> ความสัมพันธ์ระหว่างอัตราการไหลและแรงดันของปั๊ม (จำลองจาก Rated Flow และ Rated Head 100 PSI)</li>
                    <li><strong>อัตราไหลรวมที่ต้องการ (Demand Point - รูปดาวแดง):</strong> จุดปฏิบัติงานที่คำนวณได้จากปริมาณน้ำสปริงเกลอร์บวกกับปริมาณน้ำท่อยืน ที่แรงดันกำหนดของปั๊ม (100 PSI)</li>
                    <li><strong>จุดกำหนดของปั๊ม (Rated Point):</strong> จุดประสิทธิภาพสูงสุดตามสเปก (Rated Flow, Rated Head 100 PSI)</li>
                    <li><strong>จุดอ้างอิง 150% Flow, 65% Head:</strong> จุดตรวจสอบประสิทธิภาพ (150% Rated Flow, 65% Max. churn)</li>
                    <li><strong>เส้นแสดง Shut-off Head (Max. churn) (<span id="shut_off_head_value"></span> PSI):</strong> แรงดันสูงสุดที่ปั๊มสร้างได้ (ประมาณ 110% ของ Rated Head)</li>
                    <li><strong>เส้นแสดง Rated GPM (สีแดง):</strong> เส้นแนวตั้งแสดงอัตราการไหลกำหนดของปั๊ม</li>
                    <li><strong>เส้นแสดงแรงดันกำหนดจากจุด Rated Point (สีแดง):</strong> เส้นแนวนอนจากจุด Rated Point ไปยังแกน Y เพื่อเน้นแรงดันกำหนด</li>
                    <li><strong>เส้นแสดง 65% Head (จุดอ้างอิง):</strong> เส้นแนวนอนแสดง 65% ของแรงดันสูงสุดที่อัตราการไหลเป็นศูนย์</li>
                </ul>
            </div>

            <p class="chart-disclaimer">
                * กราฟนี้เป็นเพียงการจำลอง Performance Curve อย่างง่าย ไม่ใช่ข้อมูลจำเพาะที่แท้จริง โปรดอ้างอิงข้อมูลจากผู้ผลิตและวิศวกร.
            </p>
        </div>

        <div class="print-pdf-buttons mt-6 flex flex-col space-y-4">
            <button onclick="window.print()" class="btn-secondary rounded-lg shadow-md">พิมพ์ (Print)</button>
            <button onclick="window.print()" class="btn-secondary rounded-lg shadow-md">ส่งออกเป็น PDF (Export to PDF)</button>
            <small class="small-text text-center">
                สำหรับการส่งออกเป็น PDF โปรดเลือก "บันทึกเป็น PDF" ในหน้าต่างการพิมพ์ของเบราว์เซอร์
            </small>
        </div>
    </div>

    <script>
        // Data อ้างอิงจาก NFPA 13 (ค่าโดยประมาณและสำหรับการสาธิต)
        const NFPA_DATA = {
            'light': { density_gpm_sqft: 0.10, hose_allowance_gpm: 100, min_duration: 30 },
            'ordinary1': { density_gpm_sqft: 0.15, hose_allowance_gpm: 250, min_duration: 60 },
            'ordinary2': { density_gpm_sqft: 0.20, hose_allowance_gpm: 250, min_duration: 90 },
            'extra1': { density_gpm_sqft: 0.30, hose_allowance_gpm: 500, min_duration: 90 },
            'extra2': { density_gpm_sqft: 0.40, hose_allowance_gpm: 500, min_duration: 120 }
        };

        // Conversion Factors
        const SQ_M_TO_SQ_FT = 10.7639;
        const US_GALLONS_TO_CUBIC_METERS = 0.00378541;

        // Chart instances
        let pumpCurveChart;

        // Constant for pump rated head
        const PUMP_RATED_HEAD_PSI = 100;

        // Function to toggle visibility of calculation explanations
        function toggleSprinklerCalculation() {
            document.getElementById('sprinkler_flow_calculation').classList.toggle('hidden');
        }
        function toggleTankVolumeCalculation() {
            document.getElementById('tank_volume_calculation').classList.toggle('hidden');
        }
        function toggleDemandHeadCalculation() {
            document.getElementById('demand_head_calculation').classList.toggle('hidden');
        }

        // Function to interpolate head on the pump curve
        function getHeadOnPumpCurve(flow, ratedFlow, ratedHead) {
            const shutOffHead = ratedHead * 1.10;
            const maxFlowAt65Head = ratedFlow * 1.5;
            const headAtMaxFlow = ratedHead * 0.65;

            const curvePoints = [
                { x: 0, y: shutOffHead },
                { x: ratedFlow * 0.5, y: ratedHead + (shutOffHead - ratedHead) * 0.5 },
                { x: ratedFlow, y: ratedHead },
                { x: maxFlowAt65Head, y: headAtMaxFlow }
            ];

            if (flow <= curvePoints[0].x) return curvePoints[0].y;
            if (flow >= curvePoints[curvePoints.length - 1].x) return curvePoints[curvePoints.length - 1].y;

            for (let i = 0; i < curvePoints.length - 1; i++) {
                const p0 = curvePoints[i];
                const p1 = curvePoints[i+1];

                if (flow >= p0.x && flow <= p1.x) {
                    return p0.y + (p1.y - p0.y) * ((flow - p0.x) / (p1.x - p0.x));
                }
            }
            return 0;
        }

        // Function to get flow for a given head on the pump curve
        function getFlowForHeadOnCurve(targetHead, ratedFlow, ratedHead) {
            const shutOffHead = ratedHead * 1.10;
            const maxFlowAt65Head = ratedFlow * 1.5;
            const headAtMaxFlow = ratedHead * 0.65;

            const curvePoints = [
                { x: 0, y: shutOffHead },
                { x: ratedFlow * 0.5, y: ratedHead + (shutOffHead - ratedHead) * 0.5 },
                { x: ratedFlow, y: ratedHead },
                { x: maxFlowAt65Head, y: headAtMaxFlow }
            ];

            curvePoints.sort((a, b) => a.x - b.x);

            if (targetHead > shutOffHead) return { flow: 0, head: shutOffHead };
            if (targetHead < headAtMaxFlow) return { flow: maxFlowAt65Head, head: headAtMaxFlow };

            for (let i = 0; i < curvePoints.length - 1; i++) {
                const p0 = curvePoints[i];
                const p1 = curvePoints[i + 1];

                if ((targetHead <= p0.y && targetHead >= p1.y) || (targetHead >= p0.y && targetHead <= p1.y)) {
                    if (p1.y === p0.y) return { flow: p0.x, head: targetHead };
                    const interpolatedFlow = p0.x + (targetHead - p0.y) * (p1.x - p0.x) / (p1.y - p0.y);
                    return { flow: interpolatedFlow, head: targetHead };
                }
            }
            return { flow: 0, head: 0 };
        }


        // Function for Pump Curve Chart
        function updatePumpCurveChart(ratedFlow, ratedHead, totalRequiredFlow) {
            const ctx = document.getElementById('pumpCurveChart').getContext('2d');

            const shutOffHead = ratedHead * 1.10;
            const maxPumpCurveFlow = ratedFlow * 1.5;

            const flowPoints = [0, ratedFlow * 0.5, ratedFlow, maxPumpCurveFlow];
            const headPoints = [
                shutOffHead,
                ratedHead + (shutOffHead - ratedHead) * 0.5,
                ratedHead,
                ratedHead * 0.65
            ];

            let purplePointFlow = ratedFlow * 1.5;
            let purplePointHead = shutOffHead * 0.65;
            if (purplePointHead < 0) purplePointHead = 0;

            const fillPolygonPoints = [];
            const maxRangeFlowForShade = ratedFlow * 1.5;
            const minHeadForRange = shutOffHead * 0.65;
            if (minHeadForRange < 0) minHeadForRange = 0;

            fillPolygonPoints.push({ x: 0, y: minHeadForRange });
            fillPolygonPoints.push({ x: maxRangeFlowForShade, y: minHeadForRange });

            const numStepsForFillCurve = 50;
            const stepSizeForFillCurve = maxRangeFlowForShade > 0 ? maxRangeFlowForShade / numStepsForFillCurve : 0;

            for (let i = numStepsForFillCurve; i >= 0; i--) {
                const currentFlow = i * stepSizeForFillCurve;
                const currentHeadOnCurve = getHeadOnPumpCurve(currentFlow, ratedFlow, ratedHead);
                fillPolygonPoints.push({ x: currentFlow, y: Math.max(currentHeadOnCurve, minHeadForRange) });
            }

            let maxXValue = Math.max(maxPumpCurveFlow, ratedFlow, totalRequiredFlow) * 1.1;
            let maxYValue = Math.max(200, shutOffHead * 1.15, purplePointHead, ratedHead) * 1.1;


            const chartData = {
                labels: [],
                datasets: []
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: { display: true, text: 'อัตราการไหล (Flow Rate - GPM)' },
                        beginAtZero: true,
                        max: maxXValue,
                        ticks: { stepSize: 25 }
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'แรงดัน (Head - PSI)' },
                        beginAtZero: true,
                        max: maxYValue,
                        ticks: { stepSize: 10 }
                    }
                },
                plugins: {
                    legend: { display: true, position: 'top', labels: { font: { size: 12 } } },
                    title: { display: true, text: 'กราฟ Flow Rate vs. Head (Performance Curve จำลอง)' }
                }
            };

            // 1. Recommended Operating Range (Green shaded area)
            chartData.datasets.push({
                label: 'พื้นที่ปฏิบัติงานที่แนะนำ (สีเขียว)',
                data: fillPolygonPoints,
                backgroundColor: 'rgba(0, 128, 0, 0.9)',
                borderColor: 'transparent',
                fill: true,
                pointRadius: 0,
                showLine: true,
                tension: 0.2,
                order: 0
            });

            // 2. Performance Curve (Teal line)
            if (ratedFlow > 0 && ratedHead > 0) {
                chartData.datasets.push({
                    label: 'Performance Curve จำลอง (Pump)',
                    data: flowPoints.map((flow, index) => ({ x: flow, y: headPoints[index] })),
                    fill: false,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    tension: 0.2,
                    pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: 'rgba(75, 192, 192, 1)',
                    pointHoverBorderColor: '#fff',
                    showLine: true,
                    order: 1
                });
            }

            // 3. Shut-off Head (Max. churn) line (Dark red dashed)
            if (!isNaN(ratedHead) && ratedHead > 0) {
                chartData.datasets.push({
                    type: 'line',
                    label: `เส้นแสดง Shut-off Head (Max. churn): ${shutOffHead.toFixed(2)} PSI`, // Added numeric value to label
                    data: [
                        { x: 0, y: shutOffHead },
                        { x: maxXValue, y: shutOffHead }
                    ],
                    fill: false,
                    borderColor: 'rgba(192, 75, 75, 0.7)',
                    borderDash: [6, 6],
                    pointRadius: 0,
                    hoverBorderWidth: 0,
                    tension: 0,
                    order: 3
                });
            }

            // 4. Rated Point (Yellow circle) and its associated red dashed lines
            if (!isNaN(ratedFlow) && ratedFlow > 0 && !isNaN(ratedHead) && ratedHead > 0) {
                // Rated Point itself
                chartData.datasets.push({
                    type: 'scatter',
                    label: 'จุดกำหนดของปั๊ม (Rated Point)',
                    data: [{ x: ratedFlow, y: ratedHead }],
                    backgroundColor: 'rgba(255, 206, 86, 1)',
                    borderColor: 'rgba(255, 206, 86, 1)',
                    pointRadius: 7,
                    pointStyle: 'circle',
                    hoverBackgroundColor: 'rgba(255, 206, 86, 1)',
                    hoverBorderColor: '#fff',
                    hoverBorderWidth: 2,
                    order: 2
                });

                // Vertical dashed line for Rated GPM (red and dotted)
                chartData.datasets.push({
                    type: 'line',
                    label: 'เส้นแสดง Rated GPM (สีแดง)',
                    data: [
                        { x: ratedFlow, y: 0 },
                        { x: ratedFlow, y: ratedHead }
                    ],
                    fill: false,
                    borderColor: 'rgba(255, 0, 0, 0.7)',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    hoverBorderWidth: 0,
                    tension: 0,
                    order: 3
                });

                // Horizontal dashed line from Rated Point to Y-axis (red and dotted)
                chartData.datasets.push({
                    type: 'line',
                    label: 'เส้นแสดงแรงดันกำหนดจากจุด Rated Point (สีแดง)',
                    data: [
                        { x: 0, y: ratedHead },
                        { x: ratedFlow, y: ratedHead }
                    ],
                    fill: false,
                    borderColor: 'rgba(255, 0, 0, 0.7)',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    hoverBorderWidth: 0,
                    tension: 0,
                    order: 3
                });
            }

            // 5. 150% Flow, 65% Head point (Purple rectRot) and its associated purple dashed lines
            if (ratedFlow > 0 && ratedHead > 0) {
                chartData.datasets.push({
                    type: 'scatter',
                    label: 'จุดอ้างอิงที่ 150% Flow, 65% Head (จากแรงดันสูงสุดที่อัตราการไหลเป็นศูนย์)',
                    data: [{ x: purplePointFlow, y: purplePointHead }],
                    backgroundColor: 'rgba(153, 102, 255, 1)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    pointRadius: 7,
                    pointStyle: 'rectRot',
                    hoverBackgroundColor: 'rgba(153, 102, 255, 1)',
                    hoverBorderColor: '#fff',
                    hoverBorderWidth: 2,
                    order: 2
                });

                chartData.datasets.push({
                    type: 'line',
                    label: 'เส้นแสดง 150% Flow (จุดอ้างอิง)',
                    data: [
                        { x: purplePointFlow, y: 0 },
                        { x: purplePointFlow, y: purplePointHead }
                    ],
                    fill: false,
                    borderColor: 'rgba(153, 102, 255, 0.7)',
                    borderDash: [4, 4],
                    pointRadius: 0,
                    hoverBorderWidth: 0,
                    tension: 0,
                    order: 3
                });

                chartData.datasets.push({
                    type: 'line',
                    label: 'เส้นแสดง 65% Head (จุดอ้างอิง)',
                    data: [
                        { x: 0, y: purplePointHead },
                        { x: maxXValue, y: purplePointHead }
                    ],
                    fill: false,
                    borderColor: 'rgba(153, 102, 255, 0.7)',
                    borderDash: [4, 4],
                    pointRadius: 0,
                    hoverBorderWidth: 0,
                    tension: 0,
                    order: 3
                });
            }

            // Add Total Required Flow as a red star point
            if (totalRequiredFlow > 0 && ratedHead !== null) {
                chartData.datasets.push({
                    type: 'scatter',
                    label: `อัตราไหลรวมที่ต้องการ (Demand Point - รูปดาวแดง): ${totalRequiredFlow.toFixed(2)} GPM`,
                    data: [{ x: totalRequiredFlow, y: ratedHead }],
                    backgroundColor: 'rgba(255, 0, 0, 1)',
                    borderColor: 'rgba(255, 0, 0, 1)',
                    pointRadius: 8,
                    pointStyle: 'star',
                    hoverBackgroundColor: 'rgba(255, 0, 0, 1)',
                    hoverBorderColor: '#fff',
                    hoverBorderWidth: 2,
                    order: 2
                });
            }

            if (pumpCurveChart) {
                pumpCurveChart.data = chartData;
                pumpCurveChart.options = chartOptions;
                pumpCurveChart.update();
            } else {
                pumpCurveChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: chartOptions
                });
            }
        }


        function calculate() {
            const areaName = document.getElementById('area_name').value;
            const hazardClass = document.getElementById('hazard_class').value;
            let designAreaSqM = parseFloat(document.getElementById('design_area').value);
            const durationInput = parseInt(document.getElementById('duration').value);
            const pumpRatedFlow = parseFloat(document.getElementById('pump_rated_flow').value); 
            const pumpRatedHead = PUMP_RATED_HEAD_PSI;
            const systemDemandHeadInput = parseFloat(document.getElementById('system_demand_head').value); 


            const data = NFPA_DATA[hazardClass];
            let warningMessage = '';
            const warningMessageElement = document.getElementById('warning_message');
            const sprinklerFlowCalculationElement = document.getElementById('sprinkler_flow_calculation');
            const tankVolumeCalculationElement = document.getElementById('tank_volume_calculation'); 
            const demandHeadDisplayContainer = document.getElementById('demand_head_display_container');
            const demandHeadDisplayElement = document.getElementById('demand_head_display');
            const demandHeadCalculationElement = document.getElementById('demand_head_calculation'); 


            // Input validation for design area
            if (isNaN(designAreaSqM) || designAreaSqM <= 0) {
                warningMessage = 'ข้อผิดพลาด: กรุณาป้อนพื้นที่ป้องกันที่ถูกต้อง (ต้องมากกว่า 0 และเป็นตัวเลข)';
                warningMessageElement.textContent = warningMessage;
                warningMessageElement.classList.remove('hidden');
                // Reset results and charts
                document.getElementById('sprinkler_flow').textContent = '0.00';
                sprinklerFlowCalculationElement.classList.add('hidden'); // Hide explanation on error
                document.getElementById('hose_allowance').textContent = '0.00';
                document.getElementById('total_flow').textContent = '0.00';
                demandHeadDisplayElement.textContent = '0.00'; // Reset head display
                demandHeadDisplayContainer.classList.add('hidden'); // Hide container
                demandHeadCalculationElement.classList.add('hidden'); // Hide demand head explanation on error
                document.getElementById('tank_volume').textContent = '0.00';
                tankVolumeCalculationElement.classList.add('hidden'); // Hide tank volume explanation
                document.getElementById('actual_duration').textContent = '0';
                document.getElementById('area_name_display').style.display = 'none';
                updatePumpCurveChart(0, 0, 0); // Reset pump curve chart, removed intersectionPoint
                return;
            } else {
                warningMessageElement.classList.add('hidden');
            }

            // Convert design area from square meters to square feet for calculation
            const designAreaSqFt = designAreaSqM * SQ_M_TO_SQ_FT;

            // Check minimum design area based on NFPA 13 (Simplified, for standard spray sprinklers)
            const minDesignAreaSqMForSprinkler = 139.4;
            if ((hazardClass === 'light' || hazardClass.startsWith('ordinary')) && designAreaSqM < minDesignAreaSqMForSprinkler) {
                warningMessage += `คำเตือน: สำหรับ ${document.getElementById('hazard_class').options[document.getElementById('hazard_class').selectedIndex].text} ควรใช้พื้นที่ป้องกันอย่างน้อย ${minDesignAreaSqMForSprinkler} ตร.ม. (ประมาณ 1500 ตร.ฟุต) ตาม NFPA 13 เพื่อการคำนวณสปริงเกลอร์มาตรฐาน. `;
            }

            // Check minimum duration based on NFPA 13
            if (durationInput < data.min_duration) {
                warningMessage += `คำเตือน: ระยะเวลาการจ่ายน้ำขั้นต่ำที่แนะนำสำหรับ ${document.getElementById('hazard_class').options[document.getElementById('hazard_class').selectedIndex].text} คือ ${data.min_duration} นาที ตาม NFPA 13.`;
            }

            // 1. Calculate Sprinkler Flow (GPM)
            const sprinklerFlowGPM = data.density_gpm_sqft * designAreaSqFt;

            // 2. Hose Stream Allowance (GPM) - This is added to the total flow
            const hoseAllowanceGPM = data.hose_allowance_gpm;

            // 3. Total Required Flow Rate (Fire Pump Size in GPM)
            const totalFlowGPM = sprinklerFlowGPM + hoseAllowanceGPM;

            // 4. Calculate Required Tank Volume (US Gallons)
            const requiredTankVolumeGallons = totalFlowGPM * durationInput; // Volume = Flow Rate * Time

            // Convert tank volume from US Gallons to Cubic Meters
            const requiredTankVolumeCubicMeters = requiredTankVolumeGallons * US_GALLONS_TO_CUBIC_METERS;

            // 5. Actual Duration - This is simply the input duration based on the calculation
            const actualDurationMinutes = durationInput; 

            // Display Results
            document.getElementById('sprinkler_flow').textContent = sprinklerFlowGPM.toFixed(2);
            document.getElementById('hose_allowance').textContent = hoseAllowanceGPM.toFixed(2);
            document.getElementById('total_flow').textContent = totalFlowGPM.toFixed(2);
            document.getElementById('tank_volume').textContent = requiredTankVolumeCubicMeters.toFixed(2);
            document.getElementById('actual_duration').textContent = actualDurationMinutes;

            // Display area name if entered
            const displayAreaNameElement = document.getElementById('display_area_name');
            const areaNameDisplayContainer = document.getElementById('area_name_display');
            if (areaName.trim() !== '') {
                displayAreaNameElement.textContent = areaName;
                areaNameDisplayContainer.style.display = 'block';
            } else {
                displayAreaNameElement.textContent = '';
                areaNameDisplayContainer.style.display = 'none'; 
            }

            // Set sprinkler flow calculation explanation (hidden by default)
            sprinklerFlowCalculationElement.textContent = `วิธีการคำนวณ: พื้นที่ป้องกัน ${designAreaSqM.toFixed(2)} ตร.ม. (${designAreaSqFt.toFixed(2)} ตร.ฟุต) x อัตราหนาแน่นน้ำ ${data.density_gpm_sqft.toFixed(2)} GPM/ตร.ฟุต = ${sprinklerFlowGPM.toFixed(2)} GPM`;
            // Note: class 'hidden' is managed by toggleSprinklerCalculation()

            // Set tank volume calculation explanation (hidden by default)
            tankVolumeCalculationElement.textContent = `วิธีการคำนวณ: อัตราการไหลรวม ${totalFlowGPM.toFixed(2)} GPM x ระยะเวลา ${durationInput} นาที = ${requiredTankVolumeGallons.toFixed(2)} แกลลอน (${requiredTankVolumeCubicMeters.toFixed(2)} ลบ.ม.)`;


            // Display warning if any
            if (warningMessage) {
                warningMessageElement.textContent = warningMessage;
                warningMessageElement.classList.remove('hidden');
            } else {
                warningMessageElement.classList.add('hidden');
            }

            // intersectionPoint is no longer used for plotting, but still calculated if needed for other purposes
            let intersectionPoint = null;
            if (!isNaN(pumpRatedFlow) && pumpRatedFlow > 0 && !isNaN(systemDemandHeadInput) && systemDemandHeadInput >= 0) {
                intersectionPoint = getFlowForHeadOnCurve(systemDemandHeadInput, pumpRatedFlow, pumpRatedHead);
            }

            // Update pump curve chart and display demand head
            if (!isNaN(pumpRatedFlow) && pumpRatedFlow > 0) { // Check only for pumpRatedFlow as head is fixed
                const calculatedRequiredHead = pumpRatedHead; // Use the fixed pumpRatedHead
                const demandHeadCalculationText = `วิธีการคำนวณ: แรงดันที่จุดต้องการถูกกำหนดให้เท่ากับแรงดันกำหนดของปั๊มที่ ${pumpRatedHead.toFixed(2)} PSI (ค่าคงที่).`;

                demandHeadDisplayElement.textContent = calculatedRequiredHead.toFixed(2);
                demandHeadDisplayContainer.classList.remove('hidden');
                demandHeadCalculationElement.textContent = demandHeadCalculationText;


                updatePumpCurveChart(pumpRatedFlow, pumpRatedHead, totalFlowGPM); // Removed intersectionPoint from call
            } else {
                // Clear or reset pump curve chart if inputs are invalid
                updatePumpCurveChart(0, PUMP_RATED_HEAD_PSI, 0); // Removed null for intersection
                demandHeadDisplayElement.textContent = '0.00';
                demandHeadDisplayContainer.classList.add('hidden');
                demandHeadCalculationElement.classList.add('hidden');
            }
        }

        // Function to clear all input data and results
        function clearData() {
            // Clear input fields
            document.getElementById('area_name').value = '';
            document.getElementById('hazard_class').value = 'light';
            document.getElementById('design_area').value = '';
            document.getElementById('duration').value = '30';
            document.getElementById('pump_rated_flow').value = '';
            document.getElementById('system_demand_head').value = ''; // Clear new input

            // Clear results display
            document.getElementById('sprinkler_flow').textContent = '0.00';
            document.getElementById('hose_allowance').textContent = '0.00';
            document.getElementById('total_flow').textContent = '0.00';
            document.getElementById('tank_volume').textContent = '0.00';
            document.getElementById('actual_duration').textContent = '0';
            document.getElementById('demand_head_display').textContent = '0.00';

            // Hide dynamic result elements and calculation explanations
            document.getElementById('area_name_display').style.display = 'none';
            document.getElementById('demand_head_display_container').classList.add('hidden');
            document.getElementById('warning_message').classList.add('hidden');
            
            document.getElementById('sprinkler_flow_calculation').classList.add('hidden');
            document.getElementById('tank_volume_calculation').classList.add('hidden');
            document.getElementById('demand_head_calculation').classList.add('hidden');
            // graph_summary is now always visible, so no need to hide it here.

            // Reset chart - Note: pumpRatedHead is now PUMP_RATED_HEAD_PSI (100)
            updatePumpCurveChart(0, PUMP_RATED_HEAD_PSI, 0); // Removed null for intersection
        }

        // Initialize calculation and charts on page load with default values
        document.addEventListener('DOMContentLoaded', () => {
            calculate();
        });
    </script>
</body>
</html>
