<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>คำนวณขนาดปั๊มดับเพลิงและถังเก็บน้ำ (NFPA)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base styles for body and container */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            border: 1px solid #e2e8f0;
        }
        /* Form group and input styling */
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #334155;
        }
        input[type="number"],
        input[type="text"], /* Added style for text input */
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
            color: #475569;
            box-sizing: border-box;
        }
        input[type="number"]:focus,
        input[type="text"]:focus, /* Added style for text input focus */
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        /* Button styling */
        .btn-primary {
            width: 100%;
            padding: 12px 20px;
            background-color: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #16a34a;
            transform: translateY(-2px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-secondary {
            width: 100%;
            padding: 12px 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        .btn-secondary:active {
            transform: translateY(0);
        }
        /* Results section styling */
        .results-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8fafc;
            border: 1px dashed #94a3b8;
            border-radius: 8px;
        }
        .results-section h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
            text-align: center;
        }
        .results-section p {
            font-size: 16px;
            color: #475569;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .results-section p strong {
            color: #1e293b;
        }
        /* Warning and disclaimer styling */
        .warning {
            color: #dc2626;
            background-color: #fef2f2;
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ef4444;
            font-weight: 500;
        }
        .disclaimer {
            font-size: 14px;
            color: #64748b;
            margin-top: 20px;
            text-align: center;
            line-height: 1.4;
        }
        .small-text {
            font-size: 13px;
            color: #64748b;
            margin-top: 5px;
            display: block;
        }
        /* Chart specific styling */
        #flowRateChart {
            margin-top: 20px;
            max-height: 300px; /* Limit chart height for better layout */
        }

        /* Print specific styles */
        @media print {
            body {
                background-color: #fff;
                -webkit-print-color-adjust: exact; /* For better color printing on some browsers */
                print-color-adjust: exact;
            }
            .container {
                box-shadow: none;
                border: none;
            }
            /* Hide buttons and disclaimer when printing */
            button, .disclaimer, .form-group:not(#area_name_group):not(#hazard_class_group):not(#design_area_group):not(#duration_group), .print-pdf-buttons {
                display: none !important;
            }
            /* Ensure results section is visible and well formatted */
            .results-section {
                border: none;
                background-color: #fff;
                padding: 0;
            }
            /* Ensure chart is visible and readable when printed */
            #flowRateChart {
                margin-top: 20px;
                max-height: none; /* Remove height limit for printing */
                width: 100% !important; /* Ensure chart takes full width */
            }
            /* Adjust margins/paddings for print */
            .container, body {
                padding: 0;
                margin: 0;
            }
            /* Ensure area name is visible in print */
            #area_name_display {
                display: block !important;
                margin-bottom: 10px;
                font-size: 16px;
                color: #475569;
            }
            #area_name_display strong {
                color: #1e293b;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            คำนวณขนาดปั๊มดับเพลิงและถังเก็บน้ำ (NFPA Guidance)
        </h1>
        <p class="disclaimer mb-6">
            เครื่องมือนี้ใช้สำหรับการประมาณการเบื้องต้นเท่านั้น ไม่สามารถใช้ทดแทนการออกแบบโดยวิศวกรผู้เชี่ยวชาญได้
            การออกแบบระบบจริงต้องพิจารณาปัจจัยทางวิศวกรรมที่ซับซ้อนอื่นๆ เสมอ โปรดปรึกษาวิศวกรที่มีใบอนุญาตสำหรับการออกแบบระบบจริง
        </p>

        <div class="form-group" id="area_name_group">
            <label for="area_name">ชื่อ/รายละเอียดพื้นที่:</label>
            <input type="text" id="area_name" placeholder="เช่น อาคารสำนักงาน A ชั้น 3" class="rounded-lg shadow-sm">
        </div>

        <div class="form-group" id="hazard_class_group">
            <label for="hazard_class">เลือกประเภทอันตราย (Occupancy Hazard Classification):</label>
            <select id="hazard_class" class="rounded-lg shadow-sm">
                <option value="light">Light Hazard (อันตรายน้อย)</option>
                <option value="ordinary1">Ordinary Hazard Group 1 (อันตรายปานกลาง กลุ่ม 1)</option>
                <option value="ordinary2">Ordinary Hazard Group 2 (อันตรายปานกลาง กลุ่ม 2)</option>
                <option value="extra1">Extra Hazard Group 1 (อันตรายมาก กลุ่ม 1)</option>
                <option value="extra2">Extra Hazard Group 2 (อันตรายมาก กลุ่ม 2)</option>
            </select>
        </div>

        <div class="form-group" id="design_area_group">
            <label for="design_area">พื้นที่ป้องกัน (Design Area - ตร.ม.):</label>
            <input type="number" id="design_area" placeholder="เช่น 139.4 ตร.ม." min="0.1" step="0.1" class="rounded-lg shadow-sm">
            <small class="small-text">
                อ้างอิง NFPA 13: Light/Ordinary Hazard อย่างน้อย 139.4 ตร.ม. (ประมาณ 1500 ตร.ฟุต) สำหรับสปริงเกลอร์มาตรฐาน
            </small>
        </div>

        <div class="form-group" id="duration_group">
            <label for="duration">ระยะเวลาการจ่ายน้ำขั้นต่ำ (นาที):</label>
            <select id="duration" class="rounded-lg shadow-sm">
                <option value="30">30 นาที (สำหรับ Light Hazard)</option>
                <option value="60">60 นาที (สำหรับ Ordinary Hazard Group 1)</option>
                <option value="90">90 นาที (สำหรับ Ordinary Hazard Group 2, Extra Hazard Group 1)</option>
                <option value="120">120 นาที (สำหรับ Extra Hazard Group 2)</option>
            </select>
            <small class="small-text">อ้างอิง NFPA 13 Table 11.2.1.2</small>
        </div>

        <button onclick="calculate()" class="btn-primary rounded-lg shadow-md mb-4">คำนวณ</button>

        <div id="results" class="results-section">
            <h2>ผลการคำนวณ:</h2>
            <p id="area_name_display" style="display:none;">
                <strong>สำหรับพื้นที่:</strong> <span id="display_area_name"></span>
            </p>
            <p><strong>อัตราการไหลของน้ำดับเพลิง (สปริงเกลอร์):</strong> <span id="sprinkler_flow">0.00</span> GPM</p>
            <p><strong>อัตราการไหลสำหรับท่อยืน (Hose Stream Allowance):</strong> <span id="hose_allowance">0.00</span> GPM</p>
            <p><strong>อัตราการไหลรวมที่ต้องการ (ขนาดปั๊มดับเพลิง):</strong> <span id="total_flow">0.00</span> GPM</p>
            <p><strong>ขนาดถังเก็บน้ำที่ต้องการ:</strong> <span id="tank_volume">0.00</span> ลบ.ม.</p>
            <p><strong>เวลากักเก็บน้ำที่คำนวณ:</strong> <span id="actual_duration">0</span> นาที</p>
            <div class="warning hidden" id="warning_message"></div>

            <h3 class="text-xl font-bold text-center text-gray-700 mt-6 mb-4">สรุปอัตราการไหลของน้ำ (GPM)</h3>
            <canvas id="flowRateChart"></canvas>
        </div>

        <div class="print-pdf-buttons mt-6 flex flex-col space-y-4">
            <button onclick="window.print()" class="btn-secondary rounded-lg shadow-md">พิมพ์ (Print)</button>
            <button onclick="window.print()" class="btn-secondary rounded-lg shadow-md">ส่งออกเป็น PDF (Export to PDF)</button>
            <small class="small-text text-center">
                สำหรับการส่งออกเป็น PDF โปรดเลือก "บันทึกเป็น PDF" ในหน้าต่างการพิมพ์ของเบราว์เซอร์
            </small>
        </div>
    </div>

    <script>
        // Data อ้างอิงจาก NFPA 13 (ค่าโดยประมาณและสำหรับการสาธิต)
        // Density ในหน่วย GPM/sq.ft.
        // Hose Stream Allowance ในหน่วย GPM
        const NFPA_DATA = {
            'light': { density_gpm_sqft: 0.10, hose_allowance_gpm: 100, min_duration: 30 }, // Light Hazard: min density 0.1 GPM/sq.ft. Hose: 100 GPM
            'ordinary1': { density_gpm_sqft: 0.15, hose_allowance_gpm: 250, min_duration: 60 }, // Ordinary Hazard Group 1: min density 0.15 GPM/sq.ft. Hose: 250 GPM
            'ordinary2': { density_gpm_sqft: 0.20, hose_allowance_gpm: 250, min_duration: 90 }, // Ordinary Hazard Group 2: min density 0.20 GPM/sq.ft. Hose: 250 GPM
            'extra1': { density_gpm_sqft: 0.30, hose_allowance_gpm: 500, min_duration: 90 }, // Extra Hazard Group 1: min density 0.30 GPM/sq.ft. Hose: 500 GPM
            'extra2': { density_gpm_sqft: 0.40, hose_allowance_gpm: 500, min_duration: 120 }  // Extra Hazard Group 2: min density 0.40 GPM/sq.ft. Hose: 500 GPM
        };

        // Conversion Factors
        const SQ_M_TO_SQ_FT = 10.7639; // 1 square meter = 10.7639 square feet
        const US_GALLONS_TO_CUBIC_METERS = 0.00378541; // 1 US gallon = 0.00378541 cubic meters

        // Chart instance
        let flowRateChart;

        function updateChart(sprinklerFlow, hoseAllowance, totalFlow) {
            const ctx = document.getElementById('flowRateChart').getContext('2d');

            const chartData = {
                labels: ['สปริงเกลอร์ (Sprinkler)', 'ท่อยืน (Hose Allowance)', 'รวม (Total Flow)'],
                datasets: [{
                    label: 'อัตราการไหล (GPM)',
                    data: [sprinklerFlow, hoseAllowance, totalFlow],
                    fill: false, // Do not fill the area under the line
                    borderColor: [
                        'rgba(75, 192, 192, 1)', // Greenish-blue for Sprinkler
                        'rgba(255, 159, 64, 1)', // Orange for Hose Allowance
                        'rgba(54, 162, 235, 1)'  // Blue for Total Flow
                    ],
                    tension: 0.1, // Smoothness of the line
                    pointBackgroundColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(54, 162, 235, 1)'
                    ],
                    pointBorderColor: '#fff',
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(54, 162, 235, 1)'
                    ],
                    pointHoverBorderColor: '#fff'
                }]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false, // Allows setting max-height
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'อัตราการไหล (GPM)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'ประเภทอัตราการไหล'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false // Hide legend as labels are on X-axis
                    },
                    title: {
                        display: true,
                        text: 'สรุปอัตราการไหลของน้ำดับเพลิง (GPM)'
                    }
                }
            };

            if (flowRateChart) {
                flowRateChart.data = chartData;
                flowRateChart.update();
            } else {
                flowRateChart = new Chart(ctx, {
                    type: 'line', // Changed to 'line' chart type
                    data: chartData,
                    options: chartOptions
                });
            }
        }

        function calculate() {
            const areaName = document.getElementById('area_name').value; // Get area name
            const hazardClass = document.getElementById('hazard_class').value;
            let designAreaSqM = parseFloat(document.getElementById('design_area').value);
            const durationInput = parseInt(document.getElementById('duration').value);

            const data = NFPA_DATA[hazardClass];
            let warningMessage = '';
            const warningMessageElement = document.getElementById('warning_message');

            // Input validation for design area
            if (isNaN(designAreaSqM) || designAreaSqM <= 0) {
                warningMessage = 'ข้อผิดพลาด: กรุณาป้อนพื้นที่ป้องกันที่ถูกต้อง (ต้องมากกว่า 0 และเป็นตัวเลข)';
                warningMessageElement.textContent = warningMessage;
                warningMessageElement.classList.remove('hidden');
                // Reset results and chart
                document.getElementById('sprinkler_flow').textContent = '0.00';
                document.getElementById('hose_allowance').textContent = '0.00';
                document.getElementById('total_flow').textContent = '0.00';
                document.getElementById('tank_volume').textContent = '0.00';
                document.getElementById('actual_duration').textContent = '0';
                document.getElementById('area_name_display').style.display = 'none'; // Hide area name on error
                updateChart(0, 0, 0); // Reset chart
                return;
            } else {
                warningMessageElement.classList.add('hidden');
            }

            // Convert design area from square meters to square feet for calculation
            const designAreaSqFt = designAreaSqM * SQ_M_TO_SQ_FT;

            // Check minimum design area based on NFPA 13 (Simplified, for standard spray sprinklers)
            // NFPA 13 typically requires a minimum design area of 1500 sq.ft. (approx. 139.4 sq.m) for Light and Ordinary hazards.
            const minDesignAreaSqMForSprinkler = 139.4;
            if ((hazardClass === 'light' || hazardClass.startsWith('ordinary')) && designAreaSqM < minDesignAreaSqMForSprinkler) {
                warningMessage += `คำเตือน: สำหรับ ${document.getElementById('hazard_class').options[document.getElementById('hazard_class').selectedIndex].text} ควรใช้พื้นที่ป้องกันอย่างน้อย ${minDesignAreaSqMForSprinkler} ตร.ม. (ประมาณ 1500 ตร.ฟุต) ตาม NFPA 13 เพื่อการคำนวณสปริงเกลอร์มาตรฐาน. `;
            }

            // Check minimum duration based on NFPA 13
            if (durationInput < data.min_duration) {
                warningMessage += `คำเตือน: ระยะเวลาการจ่ายน้ำขั้นต่ำที่แนะนำสำหรับ ${document.getElementById('hazard_class').options[document.getElementById('hazard_class').selectedIndex].text} คือ ${data.min_duration} นาที ตาม NFPA 13.`;
            }

            // 1. Calculate Sprinkler Flow (GPM)
            const sprinklerFlowGPM = data.density_gpm_sqft * designAreaSqFt;

            // 2. Hose Stream Allowance (GPM) - This is added to the total flow
            const hoseAllowanceGPM = data.hose_allowance_gpm;

            // 3. Total Required Flow Rate (Fire Pump Size in GPM)
            const totalFlowGPM = sprinklerFlowGPM + hoseAllowanceGPM;

            // 4. Calculate Required Tank Volume (US Gallons)
            const requiredTankVolumeGallons = totalFlowGPM * durationInput; // Volume = Flow Rate * Time

            // Convert tank volume from US Gallons to Cubic Meters
            const requiredTankVolumeCubicMeters = requiredTankVolumeGallons * US_GALLONS_TO_CUBIC_METERS;

            // 5. Actual Duration - This is simply the input duration based on the calculation
            const actualDurationMinutes = durationInput; 

            // Display Results
            document.getElementById('sprinkler_flow').textContent = sprinklerFlowGPM.toFixed(2);
            document.getElementById('hose_allowance').textContent = hoseAllowanceGPM.toFixed(2);
            document.getElementById('total_flow').textContent = totalFlowGPM.toFixed(2);
            document.getElementById('tank_volume').textContent = requiredTankVolumeCubicMeters.toFixed(2);
            document.getElementById('actual_duration').textContent = actualDurationMinutes;

            // Display area name if entered
            const displayAreaNameElement = document.getElementById('display_area_name');
            const areaNameDisplayContainer = document.getElementById('area_name_display');
            if (areaName.trim() !== '') {
                displayAreaNameElement.textContent = areaName;
                areaNameDisplayContainer.style.display = 'block';
            } else {
                displayAreaNameElement.textContent = '';
                areaNameDisplayContainer.style.display = 'none';
            }

            // Display warning if any
            if (warningMessage) {
                warningMessageElement.textContent = warningMessage;
                warningMessageElement.classList.remove('hidden');
            } else {
                warningMessageElement.classList.add('hidden');
            }

            // Update the chart with new calculated values
            updateChart(sprinklerFlowGPM, hoseAllowanceGPM, totalFlowGPM);
        }

        // Initialize calculation and chart on page load with default values
        document.addEventListener('DOMContentLoaded', () => {
            calculate();
        });
    </script>
</body>
</html>
